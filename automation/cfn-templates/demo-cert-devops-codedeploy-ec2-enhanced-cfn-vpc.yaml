---
AWSTemplateFormatVersion: '2010-09-09'
Description: >
  A VPC declaration comprising a public and private subnet, spaning two
  availability zones. The following auxillary components are included here:

  Public & Private Route Tables.
  An Internet Gatway.

  CIDR Allocations:

  Public Subnet Total      : 10.0.128.0/18
  Availability Zone A CIDR : 10.0.128.0/20
  Availability Zone B CIDR : 10.0.144.0/20

  Private Subnet Total     : 10.0.0.0/17
  Availability Zone A CIDR : 10.0.0.0/19
  Availability Zone B CIDR : 10.0.32.0/19

# ------------------------------------------


# ==========================================
Metadata: {}
# Metadata:


# ==========================================
# Parameters {}
Parameters:

  # ------------------------------------------
  # --- The Project Name
  ProjectName:
    Description: "Name of this particular project"
    ConstraintDescription: "Specify name of this project"
    Type: String
    Default: "demo-cert-devops-codedeploy-sample-github"
    MinLength: 3
    MaxLength: 63
    AllowedPattern:
      (?!^(\d{1,3}\.){3}\d{1,3}$)(^[a-z0-9]([a-z0-9-]*(\.[a-z0-9])?)*$(?<!\-))


# ==========================================
Resources:

  # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  #         TOP LEVEL CIDR DEFINITION
  # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~


  # ------------------------------------------
  # --- VPC Definition
  VPC:
    Type: "AWS::EC2::VPC"
    # .............................
    Properties:
      CidrBlock: "10.0.0.0/16"
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: "Name"
          Value:
            !Sub "${ProjectName}-vpc"


  # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  #         SUBNET DEFINITIONS
  # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

  # ------------------------------------------
  # --- AZ-A Public Subnet
  PublicEC2SubnetA:
    Type: "AWS::EC2::Subnet"
    # .............................
    Properties:
      CidrBlock: "10.0.128.0/20"
      MapPublicIpOnLaunch: true
      VpcId: !Ref VPC
      AvailabilityZone:
        'Fn::Select':
          - '0'
          - 'Fn::GetAZs':
              Ref: 'AWS::Region'
      Tags:
        - Key: "Name"
          Value:
            !Sub "pubA-${ProjectName}"

  # ------------------------------------------
  # --- AZ-B Public Subnet
  PublicEC2SubnetB:
    Type: "AWS::EC2::Subnet"
    # .............................
    Properties:
      CidrBlock: "10.0.144.0/20"
      MapPublicIpOnLaunch: true
      VpcId: !Ref VPC
      AvailabilityZone:
        'Fn::Select':
          - '1'
          - 'Fn::GetAZs':
              Ref: 'AWS::Region'
      Tags:
        - Key: "Name"
          Value:
            !Sub "pubB-${ProjectName}"

  # ------------------------------------------
  # --- AZ1 Private Subnet
  PrivateEC2SubnetA:
    Type: "AWS::EC2::Subnet"
    # .............................
    Properties:
      CidrBlock: "10.0.0.0/19"
      MapPublicIpOnLaunch: false
      VpcId: !Ref VPC
      AvailabilityZone:
        'Fn::Select':
          - '0'
          - 'Fn::GetAZs':
              Ref: 'AWS::Region'
      Tags:
        - Key: "Name"
          Value:
            !Sub "privA-${ProjectName}"

  # ------------------------------------------
  # --- AZ-B Private Subnet
  PrivateEC2SubnetB:
    Type: "AWS::EC2::Subnet"
    # .............................
    Properties:
      CidrBlock: "10.0.32.0/19"
      MapPublicIpOnLaunch: false
      VpcId: !Ref VPC
      AvailabilityZone:
        'Fn::Select':
          - '1'
          - 'Fn::GetAZs':
              Ref: 'AWS::Region'
      Tags:
        - Key: "Name"
          Value:
            !Sub "privB-${ProjectName}"


  # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  #         ROUTE TABLE DEFINITIONS
  # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

  # ------------------------------------------
  # --- Public Route Table
  RouteTablePublic:
    Type: "AWS::EC2::RouteTable"
    # .............................
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: "Name"
          Value:
            !Sub "${ProjectName}-PubRoute"

  # ------------------------------------------
  RouteTablePublicAssociationA:
    Type: "AWS::EC2::SubnetRouteTableAssociation"
    # .............................
    Properties:
      RouteTableId: !Ref RouteTablePublic
      SubnetId: !Ref PublicEC2SubnetA

  # ------------------------------------------
  RouteTablePublicAssociationB:
    Type: "AWS::EC2::SubnetRouteTableAssociation"
    # .............................
    Properties:
      RouteTableId: !Ref RouteTablePublic
      SubnetId: !Ref PublicEC2SubnetB

  # ------------------------------------------
  RouteTablePublicRoute0:
    Type: "AWS::EC2::Route"
    # .............................
    Properties:
      DestinationCidrBlock: "0.0.0.0/0"
      RouteTableId: !Ref RouteTablePublic
      GatewayId: !Ref Igw

  # ------------------------------------------
  # --- Private A Route Table
  RouteTablePrivateA:
    Type: "AWS::EC2::RouteTable"
    # .............................
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: "Name"
          Value:
            !Sub "${ProjectName}-PrivRouteA"

  # ------------------------------------------
  RouteTablePrivateAAssociation1:
    Type: "AWS::EC2::SubnetRouteTableAssociation"
    # .............................
    Properties:
      RouteTableId: !Ref RouteTablePrivateA
      SubnetId: !Ref PrivateEC2SubnetA

  # ------------------------------------------
  # --- Private B Route Table
  RouteTablePrivateB:
    Type: "AWS::EC2::RouteTable"
    # .............................
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: "Name"
          Value:
            !Sub "${ProjectName}-PrivRouteB"
  # ------------------------------------------
  RouteTablePrivateBAssociation1:
    Type: "AWS::EC2::SubnetRouteTableAssociation"
    # .............................
    Properties:
      RouteTableId: !Ref RouteTablePrivateB
      SubnetId: !Ref PrivateEC2SubnetB


  # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  #         GATEWAY DEFINITIONS
  # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

  # ------------------------------------------
  # --- Internet Gateway
  Igw:
    Type: "AWS::EC2::InternetGateway"
    # .............................
    Properties: {}

  # ------------------------------------------
  # --- Internet Gateway Attachment
  IGWAttachment:
    Type: "AWS::EC2::VPCGatewayAttachment"
    # .............................
    Properties:
      VpcId: !Ref VPC
      InternetGatewayId: !Ref Igw


# ==========================================
# Outputs: {}
Outputs:

  # ------------------------------------------
  # ---Top Level VPCID Export
  VPCID:
    Description: "VPC ID"
    Value: !Ref VPC

  # ------------------------------------------
  # ---Public Subnet AZ-A Export
  PublicEC2SubnetIdA:
    Description: "Public Subnet ID AZ-A"
    Value: !Ref PublicEC2SubnetA

  # ------------------------------------------
  # ---Public Subnet AZ-B Export
  PublicEC2SubnetIdB:
    Description: "Public Subnet ID AZ-B"
    Value: !Ref PublicEC2SubnetB

  # ------------------------------------------
  # ---Private Subnet AZ-A Export
  PrivateEC2SubnetIdA:
    Description: "Private Subnet ID AZ-A"
    Value: !Ref PrivateEC2SubnetA

  # ------------------------------------------
  # ---Private Subnet AZ-B Export
  PrivateEC2SubnetIdB:
    Description: "Private Subnet ID AZ-B"
    Value: !Ref PrivateEC2SubnetB
